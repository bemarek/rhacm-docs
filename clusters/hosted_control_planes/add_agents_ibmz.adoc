[#hosted-bare-metal-adding-agents-ibmz]
= Adding IBM Z agents to the InfraEnv resource (Technology Preview)

Adding agents in an IBM Z environment requires additional steps, which are described in detail in this section. 

*Note:* Unless stated otherwise, these procedures apply to both z/VM and RHEL KVM installations on IBM Z and IBM LinuxONE.

[#hosted-bare-metal-adding-agents-ibmz-kvm]
== Adding IBM Z KVM as Agents

For IBM Z with KVM, run the following command to start your IBM Z environment with the downloaded PXE images from the `InfraEnv` resource. After the Agents are created, the host communicates with the Assisted Service and registers in the same namespace as the `InfraEnv` resource on the management cluster.

[source,bash]
----
virt-install \
   --name "<vm_name>" \
   --autostart \
   --ram=16384 \
   --cpu host \
   --vcpus=4 \
   --location "<path_to_kernel_initrd_image>,kernel=kernel.img,initrd=initrd.img" \
   --disk <qcow_image_path> \
   --network network:macvtap-net,mac=<mac_address> \
   --graphics none \
   --noautoconsole \
   --wait=-1 \
   --extra-args "rd.neednet=1 nameserver=<nameserver>   coreos.live.rootfs_url=http://<http_server>/rootfs.img random.trust_cpu=on rd.luks.options=discard ignition.firstboot ignition.platform.id=metal console=tty1 console=ttyS1,115200n8 coreos.inst.persistent-kargs=console=tty1 console=ttyS1,115200n8"
----

For ISO boot, download ISO from the `InfraEnv` resource and boot the nodes by running the following command:

[source,bash]
----
virt-install \
  --name "<vm_name>" \
  --autostart \
  --memory=16384 \
  --cpu host \
  --vcpus=4 \
  --network network:macvtap-net,mac=<mac_address> \
  --cdrom "<path_to_image.iso>" \
  --disk <qcow_image_path> \
  --graphics none \
  --noautoconsole \
  --os-variant <os_version> \
  --wait=-1 \
----

[#hosted-bare-metal-adding-agents-ibmz-zvm]
== Adding IBM Z LPAR as Agents

{ocp-short} 4.16 allows you to add the Logical Partition (LPAR) on IBM Z or IBM LinuxONE as a **Compute node** to a hosted control plane.

=== Procedure

. Create a boot parameter file for the agents.
+
.Sample parameter file:
[source,yaml]
----
rd.neednet=1 coreos.live.rootfs_url=<rootfs_url> ip=<IP_guest_vm>::<nameserver>:255.255.255.0::<network_adaptor>:none nameserver=<nameserver> ai.ip_cfg_override=1 rd.znet=qeth,<network_adaptor_range>,layer2=1 rd.<disk_type>=<storage> random.trust_cpu=on rd.luks.options=discard ignition.firstboot ignition.platform.id=metal console=tty1 console=ttyS1,115200n8 coreos.inst.persistent-kargs=console=tty1 console=ttyS1,115200n8
----

. Generate the `.ins` and `initrd.img.addrsize` files.
+
The .ins file is a special file that includes installation data and is present on the FTP server. It can be accessed from the HMC system.
+
This file contains details such as mapping of the location of installation data on the disk or FTP server, the memory locations where the data is to be copied.
+
**Note**: In {ocp-short} 4.16, the .ins file and 'initrd.img.addrsize' are not automatically generated as part of boot-artifacts from the installer. You must generate these files manually.

.. Run the following commands to get the size of the kernel and initrd. 
+
[source,yaml]
----
KERNEL_IMG_PATH='./kernel.img'
INITRD_IMG_PATH='./initrd.img'
CMDLINE_PATH='./generic.prm'
kernel_size=$(stat -c%s $KERNEL_IMG_PATH )
initrd_size=$(stat -c%s $INITRD_IMG_PATH)
----
.. Round the kernel size up to the next MiB boundary. This will be the starting address of initrd.img.
+
[source,yaml]
----
offset=$(( (kernel_size + 1048575) / 1048576 * 1048576 ))
----
.. Create the kernel binary patch file holding the initrd address and size.
+
[source,yaml]
----
INITRD_IMG_NAME=$(echo $INITRD_IMG_PATH | rev | cut -d '/' -f 1 | rev)
# the kernel always sits at offset 0x00
KERNEL_OFFSET=0x00000000
KERNEL_CMDLINE_OFFSET=0x00010480
INITRD_ADDR_SIZE_OFFSET=0x00010408
OFFSET_HEX=$(printf '0x%08x\n' $offset)


# Convert address and size to binary format
printf "$(printf '%016x\n' $offset)" | xxd -r -p > temp_address.bin
printf "$(printf '%016x\n' $initrd_size)" | xxd -r -p > temp_size.bin

# Concatenate address and size binaries
cat temp_address.bin temp_size.bin > "$INITRD_IMG_NAME.addrsize"

# Clean up temporary files
rm -rf temp_address.bin temp_size.bin
----
.. Create the .ins file based on the paths of these files (kernel.img, initrd.img , initrd.img.addrsize, cmdline) and the memory locations where the data is to be copied.
+
[source,yaml]
----
# Create generic.ins file
cat > generic.ins <<EOF
$KERNEL_IMG_PATH $KERNEL_OFFSET
$INITRD_IMG_PATH $OFFSET_HEX
$INITRD_IMG_NAME.addrsize $INITRD_ADDR_SIZE_OFFSET
$CMDLINE_PATH $KERNEL_CMDLINE_OFFSET
EOF
----

. Transfer the `initrd`, `kernel`, `generic.ins` , `initrd.img.addrsize`parameter file to the File server. For details on how to transfer the files with FTP and boot, see link:https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/performing_a_standard_rhel_8_installation/installing-in-an-lpar_installing-rhel[[Installing in an LPAR].    

. Boot the machine.

. Repeat the procedure for all the other machines in the cluster.

[#hosted-bare-metal-adding-agents-ibmz-zvm]
== Adding IBM z/VM as Agents

*Note:*  If you want to use a static IP for z/VM guest, you must configure the `NMStateConfig` attribute for the z/VM agent so that the IP parameter persists in the second boot.

Complete the following steps to start your IBM Z environment with the downloaded PXE images from the `InfraEnv` resource. After the Agents are created, the host communicates with the Assisted Service and registers in the same namespace as the `InfraEnv` resource on the management cluster.

. Update the parameter file to add the `rootfs_url`, `network_adaptor` and `disk_type` values. 

+
See the following example parameter file:

+
[source,yaml]
----
rd.neednet=1 \
console=ttysclp0  \
ai.ip_cfg_override=1 \
coreos.live.rootfs_url=<rootfs_url> \
ip=<IP_guest_vm>::<nameserver>:255.255.255.0::<network_adaptor>:none \
nameserver=<nameserver> \
zfcp.allow_lun_scan=0 \ 
rd.znet=qeth,<network_adaptor_range>,layer2=1 \
rd.<disk_type>=<storage> random.trust_cpu=on \ 
rd.luks.options=discard \
ignition.firstboot ignition.platform.id=metal \
console=tty1 console=ttyS1,115200n8 \
coreos.inst.persistent-kargs="console=tty1 console=ttyS1,115200n8
----

+
<1> For installations with VSwitch, add `zfcp.allow_lun_scan=0`. Omit this entry for installations with OSA, Hipersockets, and RoCE.
<2> For installations on DASD-type disks, use `rd.dasd=` to specify the installation disk. For installations on FCP-type disks, use `rd.zfcp=`.

. Move `initrd`, kernel images, and the parameter file to the guest VM by running the following commands:

+
[source,bash]
----
vmur pun -r -u -N kernel.img $INSTALLERKERNELLOCATION/<image name>
----

+
[source,bash]
----
vmur pun -r -u -N generic.parm $PARMFILELOCATION/paramfilename
----

+
[source,bash]
----
vmur pun -r -u -N initrd.img $INSTALLERINITRAMFSLOCATION/<image name>
----

+
//lahinson - nov 2023 - adding comment to ensure proper formatting

. Run the following command from the guest VM console:

+
[source,bash]
----
cp ipl c
----

+
//lahinson - nov 2023 - adding comment to ensure proper formatting

. To list the agents and their properties, enter the following command:

+
[source,bash]
----
oc -n <hosted_control_plane_namespace> get agents
----

+
See the following example output:

+
[source,bash]
----
NAME    CLUSTER APPROVED    ROLE    STAGE
50c23cda-cedc-9bbd-bcf1-9b3a5c75804d    auto-assign
5e498cd3-542c-e54f-0c58-ed43e28b568a    auto-assign
----

. Run the following command to approve the agent. *Optional:* You can set the agent ID `<installation_disk_id>` and `<hostname>` in the specification:

+
[source,bash]
----
oc -n <hosted_control_plane_namespace> patch agent 50c23cda-cedc-9bbd-bcf1-9b3a5c75804d -p '{"spec":{"installation_disk_id":"/dev/sda","approved":true,"hostname":"worker-zvm-0.hostedn.example.com"}}' --type merge
----

. Run the following command to verify that the agents are approved:

+
[source,bash]
----
oc -n <hosted_control_plane_namespace> get agents
----

+
See the following example output:

+
[source,bash]
----
NAME                                            CLUSTER     APPROVED   ROLE          STAGE
50c23cda-cedc-9bbd-bcf1-9b3a5c75804d             true       auto-assign
5e498cd3-542c-e54f-0c58-ed43e28b568a             true       auto-assign
----
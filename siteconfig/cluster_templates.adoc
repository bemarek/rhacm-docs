[#cluster-templates]
= Cluster templates overview

Cluster templates are data-driven templates used to generate the set of installation artifacts.
These templates follow the Golang text/template format and they are instantiated by using data from the `ClusterInstance` CR.
This enables dynamic creation of installation manifests for each target cluster that has similar configurations but with different values.
You can also create multiple sets based on the different installation methods or cluster topologies.

There are two types of cluster templates:

* Cluster-level templates that must reference only cluster-specific fields.
* Node-level templates that can reference both cluster-specific and node-specific fields.

You can customize the templated fields as the {sco} supports all link:https://masterminds.github.io/sprig/[sprig library functions].
Additionally, the `ClusterInstance` API provides a new function that you can use while creating your custom manifests:

`toYaml`:: The `toYaml` function encodes an item into a YAML string. If the item cannot be converted to YAML the function returns an empty string.

.Example use of .toYaml in the ClusterInstance.Spec.Proxy field
[source,yaml]
----
[...]
{{ if .Spec.Proxy }}
  proxy:
{{ .Spec.Proxy | toYaml | indent 4 }}
{{ end }}
[...]
----

The {sco} provides the following default, validated, immutable set of templates in the same namespace in which the Operator is installed:

.Default set of templates
[cols=3*, width="95%", options="header"]
|====

|Installation method
|Template type
|Template content

.2+|Assisted Installer
a|Cluster-level templates +
(`ai-cluster-templates-v1.yaml`)
a|`AgentClusterInstall` +
`ClusterDeployment` +
`InfraEnv` +
`KlusterletAddonConfig` +
`ManagedCluster`


a|Node-level templates +
(`ai-node-templates-v1.yaml`)
a|`BareMetalHost` +
`NMStateConfig`


.2+|Image-based Install Operator
a|Cluster-level templates +
(`ibi-cluster-templates-v1.yaml`)
a|`ClusterDeployment` +
`KlusterletAddonConfig` +
`ManagedCluster` +

a|Node-level templates +
(`ibi-node-templates-v1.yaml`)
a|`BareMetalHost` +
`ImageClusterInstall` +
`NetworkConfigMap`

|====

* <<special-template-variables,Special template variables>>
* <<sync-wave-annotation,Manifest order with the `siteconfig.open-cluster-management.io/sync-wave` annotation>>

[#special-template-variables]
== Special template variables

The {sco} provides a set of special template variables that you can use in your templates.

`CurrentNode`:: The {sco} explicitly controls the iteration of the node objects and exposes this variable to access all the content for the current node being handled in templating.
`InstallConfigOverrides`:: Contains the merged `networkType`, `cpuPartitioningMode` and `installConfigOverrides` content.
`ControlPlaneAgents`:: Consists of the number of control plane agents and it is automatically derived from the `ClusterInstance` node objects.
`WorkerAgents`:: Consists of the number of worker agents and it is automatically derived from the `ClusterInstance` node objects.

You can create a custom templated field by capitalizing the field name in the text template.
For example, the `ClusterInstance` `spec` fields is referenced with the `.Spec` prefix.
However, special variable fields must be referenced with the `.SpecialVars` prefix.

*Important:* Instead of using the `.Spec.Nodes` prefix for the `spec.nodes` field, it must be referenced with the `.SpecialVars.CurrentNode` special template variable.

For example, if you want to specify the `name` and `namespace` for your current node by using the `CurrentNode` special template variable, use the field names in the following form:

[source,yaml]
----
name: "{{ .SpecialVars.CurrentNode.HostName }}"
namespace: "{{ .Spec.ClusterName }}"
----

[#sync-wave-annotation]
== Manifest order with the `siteconfig.open-cluster-management.io/sync-wave` annotation

You can control the order in which manifests are created, updated, and deleted by using the `siteconfig.open-cluster-management.io/sync-wave` annotation.
The annotation takes an integer as a value and that integer constitutes as a wave.
You can add one or several manifests to a single wave.
If not specified for a manifest, the annotation takes the default value of `0`.

The {sco} reconciles the manifests in ascending order when creating or updating resources and it deletes resources in descending order.

In the following example, if the {sco} creates or updates the manifests, the `AgentClusterInstall` and `ClusterDeployment` CRs are reconciled in the first wave, while `KlusterletAddonConfig` and `ManagedCluster` CRs are reconciled in the third wave.
If the {sco} deletes the resources, `KlusterletAddonConfig` and `ManagedCluster` CRs are the first to be deleted, while the `AgentClusterInstall` and `ClusterDeployment` CRs are the last.

include::../siteconfig/siteconfig_ai_cluster_templates_v1.adoc[]